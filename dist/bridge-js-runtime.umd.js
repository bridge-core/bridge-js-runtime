(function(o,d){typeof exports=="object"&&typeof module!="undefined"?d(exports,require("@swc/wasm-web"),require("pathe"),require("magic-string"),require("json5")):typeof define=="function"&&define.amd?define(["exports","@swc/wasm-web","pathe","magic-string","json5"],d):(o=typeof globalThis!="undefined"?globalThis:o||self,d(o.BridgeJsRuntime={},o.init,o.pathe,o.MagicString,o.json5))})(this,function(o,d,p,h,y){"use strict";function _(u){return u&&typeof u=="object"&&"default"in u?u:{default:u}}var v=_(d),m=_(h),M=_(y);function g(u,e,i=0){const r=new m.default(u),n=(t,s,a)=>r.overwrite(t-i,s-i,a),f=(t,s)=>r.slice(t-i,s-i);let c="";return e.forEach(t=>{if(t.type==="ExportDefaultDeclaration")n(t.span.start,t.span.end,`
___module.__default__ = ${f(t.decl.span.start,t.decl.span.end)};`);else if(t.type==="ExportDefaultExpression")n(t.span.start,t.span.end,`
___module.__default__ = ${f(t.expression.span.start,t.expression.span.end)};`);else if(t.type==="ExportDeclaration")n(t.span.start,t.span.end,f(t.declaration.span.start,t.declaration.span.end)),t.declaration.type==="ClassDeclaration"||t.declaration.type==="FunctionDeclaration"?c+=`
___module.${t.declaration.identifier.value} = ${t.declaration.identifier.value};`:t.declaration.type==="VariableDeclaration"&&t.declaration.declarations.forEach(s=>{c+=`
___module.${s.id.value} = ${s.id.value};`});else if(t.type==="ExportNamedDeclaration"){let s="";for(const{orig:a,exported:l}of t.specifiers)l.value==="default"?s+=`
___module.__default__ = ${a.value};`:s+=`
___module.${l.value} = ${a.value};`;n(t.span.start,t.span.end,s)}else if(t.type==="ImportDeclaration")if(t.specifiers.length===1&&t.specifiers[0].type==="ImportNamespaceSpecifier")n(t.span.start,t.span.end,`
const ${t.specifiers[0].local.value} = await ___require(${t.source.raw});`);else{const s=[];t.specifiers.forEach(l=>{l.type==="ImportDefaultSpecifier"?s.push(`__default__: ${l.local.value}`):l.type==="ImportSpecifier"&&(l.imported||(l.imported=l.local),s.push(`${l.imported.value}: ${l.local.value}`))});const a=s.length===0?`
await ___require(${t.source.raw});`:`
const {${s.join(", ")}} = await ___require(${t.source.raw});`;n(t.span.start,t.span.end,a)}}),r.toString()+c}class w{constructor(e,i){this.__default__=e;for(const[r,n]of Object.entries(i))this[r]=n}}const $=typeof process!="undefined"&&typeof process.release!="undefined"&&process.release.name==="node";class b{constructor(e){if(this.evaluatedModules=new Map,this.baseModules=new Map,this.moduleLoaders=new Map,this.env={},e)for(const[i,r]of e)this.registerModule(i,r)}async run(e,i={},r){return typeof r=="string"&&(r=new File([r],p.basename(e))),await this.eval(e,i,r)}clearCache(){this.evaluatedModules.clear()}registerModule(e,i){this.baseModules.set(e,i)}deleteModule(e){this.baseModules.delete(e)}addModuleLoader(e,i){this.baseModules.set(e,i)}async eval(e,i,r){const n=this.evaluatedModules.get(e);if(n)return n;const f=p.dirname(e);if(r||(r=await this.readFile(e).catch(()=>{})),!r)throw new Error(`File "${e}" not found`);const c=await r.text(),t=await this.transformSource(e,c),s={};try{await this.runSrc(t,Object.assign({},i,{___module:s,___require:a=>this.require(a,f,i)}))}catch(a){throw new Error(`Error in ${e}: ${a}`)}return this.evaluatedModules.set(e,s),s}async transformSource(e,i){const r=e.endsWith(".js")?"ecmascript":"typescript";if(o.loadedWasm===null&&!$)throw new Error("You must call initRuntimes() before using the runtime");await o.loadedWasm;let n=d.minifySync(d.transformSync(i,{filename:p.basename(e),jsc:{parser:{syntax:r,topLevelAwait:!0},preserveAllComments:!1,target:"es2020"},isModule:!0}).code,{compress:!1,mangle:!1,format:{beautify:!0},module:!0}).code;const{type:f,body:c}=d.parseSync(n,{syntax:r,target:"es2022"}),t=c[0].span.start;return g(n,c,t)}async require(e,i,r){const n=this.baseModules.get(e);if(n)if(typeof n=="string"){const s=new File([n],e);return await this.eval(e,r,s)}else return typeof n=="function"?await n():n;if(e.startsWith("https://")){const s=await fetch(e),a=new File([await s.blob()],e);return await this.eval(e,r,a)}e.startsWith(".")&&(e=p.join(i,e));const f=p.extname(e);if(f===".json"){const s=await this.readFile(e).then(a=>a.text()).catch(()=>{});if(s){let a={};try{a=M.default.parse(s)}catch{throw new Error(`File "${e}" contains invalid JSON`)}return new w(a,a)}}const c=this.moduleLoaders.get(f);if(c){const s=this.evaluatedModules.get(e);if(s)return s;const a=await c(e);return a instanceof w?(this.evaluatedModules.set(e,a),a):await this.eval(e,r,a)}const t=[".ts",".js",""];for(const s of t){const a=`${e}${s}`;let l=await this.readFile(a).catch(()=>{});if(!!l)return await this.eval(a,r,l)}throw new Error(`Module "${e}" not found`)}async runSrc(e,i){return new Function(...Object.keys(i),`return (async () => {
${e}
})()`)(...Object.values(i))}}o.loadedWasm=null;function j(u){o.loadedWasm=v.default(u).then(()=>null)}o.Module=w,o.Runtime=b,o.initRuntimes=j,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
